generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum SourceType {
  github
  gitlab
  bitbucket
}

enum EventType {
  opened
  merged
  closed
  review_requested
  changes_requested
  pushed
  resolved
  unresolved
  dismissed
  approved
}

model Project {
  id                Int                @id @default(autoincrement())
  name              String             @unique
  repository        String             @unique // GitHub repo URL or name
  pullRequestEvents PullRequestEvent[]
}

model User {
  id                Int                @id @default(autoincrement())
  username          String             @unique
  pullRequestEvents PullRequestEvent[]
}

model Ticket {
  id                Int                @id @default(autoincrement())
  code              String             @unique // e.g. TICKET-123
  pullRequestEvents PullRequestEvent[]
}

model PullRequestEvent {
  id Int @id @default(autoincrement())

  project   Project? @relation(fields: [projectId], references: [id])
  projectId Int?

  author   User? @relation(fields: [authorId], references: [id])
  authorId Int?

  ticket   Ticket? @relation(fields: [ticketId], references: [id])
  ticketId Int?

  source SourceType

  branch       String?
  prNumber     Int?
  additions    Int?
  deletions    Int?
  changedFiles Int?

  eventType      EventType
  eventTimestamp DateTime  @default(now())

  rawPayload Json? // Optional raw webhook data for traceability

  @@index([projectId])
  @@index([authorId])
  @@index([ticketId])
  @@index([authorId, ticketId])
}
