generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum SourceType {
  github
  gitlab
  bitbucket
}

enum EventType {
  opened
  merged
  closed
  review_requested
  changes_requested
  pushed
  resolved
  unresolved
  dismissed
  approved
}

model Project {
  id                Int                @id @default(autoincrement())
  name              String             @unique
  repository        String             @unique
  pullRequestEvents PullRequestEvent[]
}

model User {
  id                Int                @id @default(autoincrement())
  username          String             @unique
  pullRequestEvents PullRequestEvent[]
}

model Ticket {
  id                Int                @id @default(autoincrement())
  code              String             @unique
  pullRequestEvents PullRequestEvent[]
}

model PullRequestEvent {
  id             Int                 @id @default(autoincrement())
  project        Project?            @relation(fields: [projectId], references: [id])
  projectId      Int?
  author         User?               @relation(fields: [authorId], references: [id])
  authorId       Int?
  reviewer       String?
  ticket         Ticket?             @relation(fields: [ticketId], references: [id])
  ticketId       Int?
  source         SourceType
  branch         String?
  prNumber       Int?
  additions      Int?
  deletions      Int?
  changedFiles   Int?
  eventType      EventType
  eventTimestamp DateTime            @default(now())
  payload        PullRequestPayload? @relation("EventPayload")

  @@index([projectId])
  @@index([authorId])
  @@index([ticketId])
  @@index([authorId, ticketId])
}

model PullRequestPayload {
  id         Int              @id @default(autoincrement())
  rawPayload Json
  event      PullRequestEvent @relation("EventPayload", fields: [eventId], references: [id])
  eventId    Int              @unique
}
